\renewcommand{\thefigure}{S\arabic{figure}}
\setcounter{figure}{0}

%\begin{figure}[htbp]
%\begin{center}
%\includegraphics[width=\textwidth]{log10-assumed.pdf} \caption{Populations in which the abundance was specified as or assumed to be recorded as log10 values. The numbers at the front of each panel label are the GPDD IDs.}
    %\label{fig:log10-assumed}
%\end{center}
%\end{figure}

\begin{figure}[htbp]
\begin{center}
\includegraphics[width=\textwidth]{all-clean-ts-3.pdf} \caption{All filtered times series used in our analysis. The abundances are shown on a log10 vertical axis. Colours indicate taxonomic classes. Open black circles indicate abundance values that were interpolated. Closed black circles indicate single abundance values that were recorded as zero but were set to the next lowest observed abundance.}
    \label{fig:all-ts}
\end{center}
\end{figure}

\clearpage

\begin{figure}[htbp]
\begin{center}
\includegraphics[width=\textwidth]{priors-gomp-base.pdf} \caption{Probability
  density of the Bayesian priors for the Gompertz models. From left to right: (1) per capita growth
  rate at $\ln$(abundance) = $0$: $\lambda \sim \mathrm{Normal}(0, 10^2)$; (2) scale
  parameter of t-distribution process noise: $\sigma \sim \mathrm{Half\mhyphen
    Cauchy} (0, 2.5)$; (3) t-distribution degrees of freedom parameter: $\nu \sim
  \mathrm{Truncated\mhyphen Exponential}(0.01, \mathrm{min.} = 2)$; (4) AR1 correlation coefficient of residuals: $\phi \sim \mathrm{Truncated \mhyphen Normal}(0, 1, \mathrm{min.} = -1, \mathrm{max.} = 1)$. Not shown is $b$, the density dependence parameter: $b \sim \mathrm{Uniform}(-1, 2)$.}
  \label{fig:priors}
\end{center}
\end{figure}

\clearpage

\begin{figure}[htbp]
\begin{center}
\includegraphics[width=0.8\textwidth]{t-dist-sampling-sim-prior-exp0point01.pdf}
\includegraphics[width=0.8\textwidth]{t-dist-sampling-sim-sigma-prior-exp0point01.pdf}
\caption{
  Testing the ability to estimate $\nu$ (top panels) and the scale parameter of the process error (bottom panels) for a given number of samples (columns) drawn from a distribution with a given true $\nu$ value (rows). The red lines indicate the true population value. When a small number of samples are drawn there may not be samples sufficiently far into the tails to recapture the true $\nu$ value; however, heavy tails are still distinguished from normal tails in most cases, even with only 25 or 50 samples. TODO switch to nu = black swan, 3, 5, and normal.
}
\label{fig:sim-nu}
\end{center}
\end{figure}

\clearpage

\begin{figure}[htbp]
\begin{center}
\includegraphics[width=\textwidth]{sim-gompertz.pdf}
\caption{Simulation testing the Gompertz estimation model when the process error draws are chosen so that $\nu$ can be estimated close to the true value outside the full population model (``effective $\nu$'' within a CV of 0.2 of specified $\nu$).
  The simulation was run across population $\nu$ values (columns) and different scenarios (colours): (1) 100 time steps and no observation error, (2) 50 time steps and no observation error, (3) 50 time steps and observation error drawn from $\mathrm{Normal} (0, 0.2^2)$ but ignored, and (4) 50 time steps with observation error in which the quantity of observation error was assumed known.
  Dashed horizontal lines show the true population values;
  these true values were chosen to represent approximately the median values as estimated from the GPDD.
  Individual dots and lines represent a stochastic draws from the true population distribution and a model fitting (median and 80\% credible intervals).
  %The panels show true values of $\nu$ =  3, 5, normal (very heavy, heavy, and not heavy tailed).
  The panels from top to bottom show $1/\nu$, process noise scale parameter $\sigma$, growth rate parameter $\lambda$, and the density dependence parameter $b$.}
\label{fig:sim-gompertz}
\end{center}
\end{figure}

\begin{figure}[htbp]
\begin{center}
\includegraphics[width=\textwidth]{sim-gompertz-boxplots.pdf}
\caption{The distribution of median estimates from the same simulation as described in Fig.~\ref{fig:sim-gompertz}. The boxes show the interquartile range. The whiskers extend to $1.5$ times the interquartile range and outliers are shown as dots.}
\label{fig:sim-gompertz-boxplots}
\end{center}
\end{figure}


\begin{figure}[htbp]
\begin{center}
\includegraphics[width=\textwidth]{check-sim-box.pdf}
\caption{The probability that $\nu < 10$ (i.e.\ the approximate probability of heavy tails) for the same simulation scenarios as shown in Fig.~\ref{fig:sim-gompertz} and Fig.~\ref{fig:sim-gompertz-boxplots}. Within each scenario the dots represent stochastic draws from the true population distributions combined with model fits.}
\label{fig:sim-prob}
\end{center}
\end{figure}


\begin{figure}[htbp]
\begin{center}
\includegraphics[width=0.9\textwidth]{ts-gpdd-heavy-eg-log10-base.pdf}
\caption{Time series for populations with p($\nu < 10$) $>$ 0.5 using the base Gompertz population model. Panels are ordered by increasing p($\nu < 10$). Vertical axes are on a log10 scale. Colours indicate taxonomic classes. TODO add dots for upswings and downswings as in Table 1. The labels on each panel indicate p($\nu < 10$) $>$ 0.5, the common name for the species, and the GPDD ID number.}
\label{fig:heavy-ts}
\end{center}
\end{figure}

\clearpage

\begin{figure}[htbp]
\begin{center}
\includegraphics[width=\textwidth]{gomp-comparison.pdf}
\caption{Estimates of $\nu$ from alternative models plotted against the base Gompertz model estimates of $\nu$. Shown are medians of the posterior (dots) and 50\% credible intervals (segments). The diagonal line indicates a one-to-one relationship. Different colours indicate various taxonomic classes. The grey-shaded regions indicate regions of disagreement if $\nu = 10$ is taken as a threshold of heavy-tailed dynamics. The Gompertz observation error model assumes a fixed standard deviation of observation error of $0.2$ on the log scale.}
\label{fig:alt}
\end{center}
\end{figure}

\clearpage


\begin{figure}[htbp]
\begin{center}
%\includegraphics[width=0.7\textwidth]{admb-coefs}
%\includegraphics[width=0.8\textwidth]{length-vs-prob-tails}
\includegraphics[width=0.5\textwidth]{stan-beta-correlates}
\caption{
  %Potential correlates of heavy-tailed dynamics.
  %(Top panels) Dots, thick lines, and thin lines represent fixed-effect estimates and their 50\% and 95\% confidence intervals for the covariates listed on the left: $\log \sigma$, $b$, $\lambda$, $\log$(lifespan), $\log$(data set length).
  Main effect posterior densitities for potential correlates of heavy-tailed dynamics.
  The response variable was Pr($\nu < 10$) (approximately the probability of heavy tails).
  The beta regression model was fit on a logit scale with random intercepts for taxonomic class, taxonomic order, and species.
  All covariates were standardized by subtracting their mean and dividing by twice their standard deviation. Therefore, the coefficient values represent the expected effect of a change in two standard deviations of the raw input variable on the logit-transformed response variable.
  %The beta distribution model (left panel) uses p$(\nu < 10)$ as the response (probability of heavy tails).
  %The binomial distribution model (right panel) uses p$(\nu < 10) > 0.5$ vs.\ p$(\nu < 10) \le 0.5$ as the response (heavy vs.\ not heavy tails).
  %The models were fitted as mixed effects models with beta or binomial distributions, logit links, and multilevel intercepts for taxonomic class and order nested within class using the \texttt{glmmADMB} \texttt{R} package \citep{fournier2012,glmmadmb}.
  %(Bottom panels) Model predictions for the strongest covariate --- time series length --- with all other predictors set to zero (their mean value when standardized). Dots represent observations for individual populations. Lines and shaded regions represent estimates and 50\% and 95\% confidence intervals.
}
    \label{fig:correlate-coefs}
\end{center}
\end{figure}

\begin{figure}[htbp]
\begin{center}
\includegraphics[width=0.75\textwidth]{perc-prob-increase-with-n}
\caption{
Expected percent increase in the probability of detecting heavy tails, Pr($\nu < 10$), with an additional ten time steps of data.
These values are based on the curve shown in Fig.~\ref{fig:correlates}d, which is based on the coefficient in Fig.~\ref{fig:correlate-coefs}.
For example, we have about a 12\% increased probability of observing heavy tails in a time series that has 60 time steps vs.\ a time series with 50 time steps.
}
\label{fig:perc-inc-p}
\end{center}
\end{figure}

% \clearpage
%
% \begin{figure}[htbp]
% \begin{center}
% \includegraphics[width=0.8\textwidth]{length-vs-prob-tails}
% \caption{Model predictions. TODO}
%     \label{fig:length-predictions}
% \end{center}
% \end{figure}

\clearpage

\noindent
Example Stan code for a heavy-tailed Gompertz model with AR1 correlated residuals and a specified level of observation error:

\begin{spacing}{1.15}
\begin{footnotesize}
\begin{verbatim}
data {
  int<lower=3> N;              // number of observations
  vector[N] y;                 // vector to hold ln abundance observations
  real<lower=0> nu_rate;       // rate parameter for nu exponential prior
}
parameters {
  real lambda;                 // Gompertz growth rate parameter
  real<lower=-1, upper=2> b;   // Gompertz density dependence parameter
  real<lower=0> sigma_proc;    // process noise scale parameter
  real<lower=2> nu;            // t-distribution degrees of freedom
  real<lower=-1, upper=1> phi; // AR1 parameter
  vector[N] U;                 // unobserved states
  real<lower=0> sigma_obs;     // specified observation error SD
}
transformed parameters {
  vector[N] epsilon;           // error terms
  epsilon[1] <- 0;
  for (i in 2:N) {
    epsilon[i] <- U[i] - (lambda + b * U[i - 1])
                       - (phi * epsilon[i - 1]);
  }
}
model {
  // priors:
  nu ~ exponential(nu_rate);
  lambda ~ normal(0, 10);
  sigma_proc ~ cauchy(0, 2.5);
  phi ~ normal(0, 1);
  // data model:
  for (i in 2:N) {
    U[i] ~ student_t(nu,
                     lambda + b * U[i - 1]
                     + phi * epsilon[i - 1],
                     sigma_proc);
  }
  y ~ normal(U, sigma_obs);
}
\end{verbatim}
\end{footnotesize}

\clearpage
\noindent
Stan code for the multilevel beta regression:
\begin{footnotesize}
\verbatiminput{betareg4.stan}
\end{footnotesize}

\clearpage

\noindent
The GPDD IDs used in our analysis:

\begin{footnotesize}
\noindent
{\tt
\input{mainids}
}
\end{footnotesize}
\end{spacing}
